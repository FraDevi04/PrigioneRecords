/**
 * @fileoverview Main application entry point.
 * Initializes the router, stores, and global components.
 */
import Router from './router.js';
import routes from './routes.config.js';
import authStore from './store/auth.store.js';
import studiosStore from './store/studios.store.js';
import bookingsStore from './store/bookings.store.js';
import reviewsStore from './store/reviews.store.js';

class PrigioneRecordsApp {
    constructor() {
        this.router = null;
        this.stores = {
            auth: authStore,
            studios: studiosStore,
            bookings: bookingsStore,
            reviews: reviewsStore,
        };
    }

    async init() {
        try {
            console.log('üöÄ Initializing PrigioneRecords App...');
            console.log('üìä Debug: Start time:', new Date().toISOString());
            
            // Debug: Verifica elementi DOM essenziali
            console.log('üîç Checking DOM elements...');
            const mainContent = document.getElementById('main-content');
            const userMenu = document.getElementById('user-menu');
            const navMenu = document.getElementById('nav-menu');
            const loadingScreen = document.getElementById('loading-screen');
            
            console.log('üìã DOM elements check:', {
                mainContent: !!mainContent,
                userMenu: !!userMenu,
                navMenu: !!navMenu,
                loadingScreen: !!loadingScreen
            });

            // Debug: Verifica stores
            console.log('üè™ Checking stores...');
            console.log('üìä Stores available:', Object.keys(this.stores));
            
            // NUOVO: Verifica connettivit√† backend
            console.log('üè• Checking backend connectivity...');
            
            // Wait a bit for modules to fully load, then check for apiService
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const apiService = window.apiService;
            if (apiService && typeof apiService.waitForBackend === 'function') {
                console.log('‚úÖ ApiService found, checking backend...');
                const backendAvailable = await apiService.waitForBackend(5, 3000);
                if (!backendAvailable) {
                    console.warn('‚ö†Ô∏è Backend not available, some features may not work');
                    this.showBackendUnavailableBanner();
                } else {
                    console.log('‚úÖ Backend is available');
                    this.hideBackendUnavailableBanner();
                }
            } else {
                console.warn('‚ö†Ô∏è ApiService not available on window, skipping backend check');
                console.log('üîç Available on window:', Object.keys(window).filter(k => k.includes('api') || k.includes('Api')));
                // Don't show banner if apiService isn't available yet - it might load later
            }
            
            // Expose stores and router globally for easy access
            console.log('üåê Exposing stores globally...');
            window.stores = this.stores;
            
            console.log('üö¶ Creating router...');
            this.router = new Router(routes);
            window.router = this.router;
            console.log('‚úÖ Router created successfully');
            console.log('üìã Router instance:', this.router);
            console.log('üìã Router on window:', window.router);
            console.log('üìã Available routes:', Object.keys(routes));

            // Setup global UI components
            console.log('üé® Setting up header...');
            this.setupHeader();
            console.log('‚úÖ Header setup completed');
            
            // Listen to auth changes to update UI
            console.log('üëÇ Setting up auth listeners...');
            this.stores.auth.subscribe(this.onAuthStateChange.bind(this));
            console.log('‚úÖ Auth listeners setup completed');

            // Initial check of auth state to set correct header
            console.log('üîê Getting initial auth state...');
            const authState = this.stores.auth.getState();
            console.log('üìä Initial auth state:', authState);
            
            console.log('üé® Applying initial auth state to UI...');
            this.onAuthStateChange(authState);
            console.log('‚úÖ Initial auth state applied');

            console.log('‚è±Ô∏è Setting up loading screen timeout...');
            // Timeout di sicurezza per nascondere la schermata di loading
            this.loadingTimeout = setTimeout(() => {
                console.log('‚ö†Ô∏è Loading timeout reached, forcing hide loading screen');
                this.hideLoadingScreen();
            }, 3000);

            console.log('‚úÖ PrigioneRecords App initialized successfully');
            console.log('üìä Debug: End time:', new Date().toISOString());
            
            // Nascondi la schermata di loading
            console.log('üé≠ Hiding loading screen...');
            this.hideLoadingScreen();
        } catch (error) {
            console.error('‚ùå Error initializing app:', error);
            // Nascondi la schermata di loading anche in caso di errore
            this.hideLoadingScreen();
            
            document.getElementById('main-content').innerHTML = `
                <div class="error-container">
                    <h1>Errore di inizializzazione</h1>
                    <p>Si √® verificato un errore durante il caricamento dell'applicazione.</p>
                    <p>Dettagli: ${error.message}</p>
                    <button onclick="location.reload()">Ricarica pagina</button>
                </div>
            `;
        }
    }

    setupHeader() {
        console.log('üé® setupHeader started');
        
        // This could be a more complex component in a real app
        this.userMenu = document.getElementById('user-menu');
        this.navMenu = document.getElementById('nav-menu');
        
        console.log('üìã Header elements:', {
            userMenu: !!this.userMenu,
            navMenu: !!this.navMenu
        });

        if (this.userMenu) {
            // Add event listener for logout
            this.userMenu.addEventListener('click', e => {
                console.log('üëÜ User menu clicked:', e.target.id);
                if (e.target.id === 'logout-btn') {
                    console.log('üö™ Logout button clicked');
                    this.stores.auth.logout();
                }
            });
            console.log('‚úÖ User menu event listener added');
        } else {
            console.error('‚ùå User menu element not found!');
        }
        
        console.log('‚úÖ setupHeader completed');
    }

    hideLoadingScreen() {
        console.log('üé≠ hideLoadingScreen called');
        const loadingScreen = document.getElementById('loading-screen');
        
        if (loadingScreen) {
            console.log('‚úÖ Loading screen element found:', loadingScreen);
            console.log('üìä Current classes:', loadingScreen.className);
            console.log('üìä Current display:', loadingScreen.style.display);
            
            // Add hidden class for transition
            loadingScreen.classList.add('hidden');
            console.log('‚úÖ Added "hidden" class');
            
            // Remove the element after transition
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                loadingScreen.style.visibility = 'hidden';
                loadingScreen.style.opacity = '0';
                console.log('‚úÖ Loading screen hidden completely');
            }, 300);
            
            // Clear safety timeout if exists
            if (this.loadingTimeout) {
                clearTimeout(this.loadingTimeout);
                console.log('‚è±Ô∏è Safety timeout cleared');
            }
        } else {
            console.error('‚ùå Loading screen element not found!');
        }
    }

    onAuthStateChange(authState) {
        console.log('üîê onAuthStateChange called with:', authState);
        
        if (!this.userMenu || !this.navMenu) {
            console.error('‚ùå Missing menu elements:', {
                userMenu: !!this.userMenu,
                navMenu: !!this.navMenu
            });
            return;
        }
        
        console.log('üìã Menu elements available, proceeding with UI update');

        if (authState.isAuthenticated) {
            console.log('üë§ Updating UI for authenticated user:', authState.user?.nome);
            
            // Update user menu for logged-in user
            this.userMenu.innerHTML = `
                <div class="user-avatar" id="user-avatar-btn">
                    ${authState.user?.nome?.charAt(0)?.toUpperCase() || 'U'}
                </div>
                <div class="user-dropdown" id="user-dropdown">
                    <a href="#/profilo" class="user-dropdown-item">Profilo</a>
                    <a href="#/prenotazioni" class="user-dropdown-item">Le mie prenotazioni</a>
                    <button id="logout-btn" class="user-dropdown-item">Logout</button>
                </div>
            `;
            console.log('‚úÖ User menu updated for authenticated user');
            
            // Update nav menu for logged-in user
            this.navMenu.innerHTML = `
                <li><a href="#/dashboard" class="nav-link">Dashboard</a></li>
                <li><a href="#/studi" class="nav-link">Studi</a></li>
            `;
            console.log('‚úÖ Nav menu updated for authenticated user');

            const avatarBtn = this.userMenu.querySelector('#user-avatar-btn');
            const dropdown = this.userMenu.querySelector('#user-dropdown');
            avatarBtn?.addEventListener('click', () => dropdown?.classList.toggle('active'));
            console.log('‚úÖ Avatar dropdown event listener added');

        } else {
            console.log('üë§ Updating UI for guest user');
            
            // Update user menu for guest
            this.userMenu.innerHTML = `
                <a href="#/login" class="btn btn-outline btn-sm">Login</a>
                <a href="#/register" class="btn btn-primary btn-sm">Registrati</a>
            `;
            console.log('‚úÖ User menu updated for guest');
            
            // Update nav menu for guest
            this.navMenu.innerHTML = `
                <li><a href="#/" class="nav-link">Home</a></li>
                <li><a href="#/studi" class="nav-link">Studi</a></li>
            `;
            console.log('‚úÖ Nav menu updated for guest');
        }
        
        console.log('‚úÖ onAuthStateChange completed');
    }

    showBackendUnavailableBanner() {
        console.log('üö® Showing backend unavailable banner');
        const banner = document.getElementById('backend-status-banner');
        if (banner) {
            banner.classList.remove('hidden');
            document.body.classList.remove('banner-hidden');
            
            // Aggiungi listener per il pulsante retry
            const retryBtn = document.getElementById('retry-backend');
            if (retryBtn && !retryBtn.hasAttribute('data-listener-added')) {
                retryBtn.setAttribute('data-listener-added', 'true');
                retryBtn.addEventListener('click', async () => {
                    console.log('üîÑ Retrying backend connection...');
                    const apiService = window.apiService;
                    if (apiService) {
                        const isAvailable = await apiService.healthCheck();
                        if (isAvailable) {
                            this.hideBackendUnavailableBanner();
                            // Ricarica la pagina per reinizializzare tutto
                            window.location.reload();
                        } else {
                            console.log('‚ùå Backend still not available');
                            // Puoi aggiungere un toast di errore qui
                        }
                    }
                });
            }
        }
    }

    hideBackendUnavailableBanner() {
        console.log('‚úÖ Hiding backend unavailable banner');
        const banner = document.getElementById('backend-status-banner');
        if (banner) {
            banner.classList.add('hidden');
            document.body.classList.add('banner-hidden');
        }
    }
}


document.addEventListener('DOMContentLoaded', async () => {
    console.log('üìÑ DOMContentLoaded event fired');
    console.log('üìä Document ready state:', document.readyState);
    
    try {
        console.log('üèóÔ∏è Creating PrigioneRecordsApp instance...');
        const app = new PrigioneRecordsApp();
        
        console.log('üöÄ Starting app initialization...');
        await app.init();
        
        console.log('üåê Setting window.app...');
        window.app = app;
        
        console.log('üéâ App startup completed successfully!');
    } catch (error) {
        console.error('‚ùå Critical error during app startup:', error);
        console.error('üìä Error stack:', error.stack);
        
        // Forza la rimozione della schermata di loading anche in caso di errore critico
        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen) {
            loadingScreen.style.display = 'none';
            console.log('üÜò Loading screen force hidden due to critical error');
        }
    }
});

export default PrigioneRecordsApp; 